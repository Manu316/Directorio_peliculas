{% extends "movies/base.html" %}

{% block title %}Buscar en TMDb{% endblock %}

{% block content %}
    <style>
        .overview-clamp {
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: -webkit-box;
            -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical;
            line-clamp: 3; 
        }
        .card-link {
            text-decoration: none; 
            color: inherit;
        }

        .poster-fixed-size {
            width: 92px;
            height: 138px;
            flex-shrink: 0;
        }
        .poster-fixed-size img {
            object-fit: cover;
            width: 100%;
            height: 100%; 
        }        
    </style> 

    <h1>Buscar Películas</h1>
    <p class="lead">Busca el título en la base de datos de películas y añádelo a tu colección.</p>

    <form class="mb-4" method="GET" action="{% url 'search_movie' %}">
        <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Escribe el título de una película..." value="{{ query|default:'' }}">
            <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
    </form>

    {% if query and not results %}
        <div class="alert alert-warning">
            No se encontraron resultados para "{{ query }}".
        </div>
    {% elif results %}
        <h2>Resultados para "{{ query }}"</h2>
        <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for movie_api in results %}
                <div class="col">
                    <div class="card h-100 d-flex flex-row">
                        
                        <a href="{% url 'tmdb_detail' tmdb_id=movie_api.id %}" class="card-link poster-fixed-size rounded-start overflow-hidden flex-shrink-0">
                            {% if movie_api.poster_path %}
                                {% with poster_url='https://image.tmdb.org/t/p/w92'|add:movie_api.poster_path %}
                                    <img src="{{ poster_url }}" class="img-fluid" alt="{{ movie_api.title }}">
                                {% endwith %}
                            {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-secondary text-white text-center p-2">
                                    No hay póster
                                </div>
                            {% endif %}
                        </a>
                        
                        <div class="card-body d-flex flex-column">
                            
                            <h5 class="card-title mb-1">
                                <a href="{% url 'tmdb_detail' tmdb_id=movie_api.id %}" class="card-link">
                                    {{ movie_api.title }}
                                </a>
                            </h5>
                            
                            <p class="card-text text-muted small mb-2">
                                {% if movie_api.release_date %}
                                    {{ movie_api.release_date|date:"Y" }}
                                {% else %}
                                    Fecha desconocida
                                {% endif %}
                            </p>
                            
                            <p class="card-text small overview-clamp">{{ movie_api.overview }}</p>
                            {% with tmdb_id_str=movie_api.id|stringformat:"s" %}

                                {% if tmdb_id_str in existing_tmdb_ids %}
                                    <button type="button" class="btn btn-secondary btn-sm w-100 mt-auto" disabled>
                                        En Colección
                                    </button>      
                                {% else %}                      
                                    <form method="POST" action="{% url 'add_movie_from_tmdb' %}" class="mt-auto">
                                        {% csrf_token %}
                                        <input type="hidden" name="tmdb_id" value="{{ movie_api.id }}">
                                        <input type="hidden" name="title" value="{{ movie_api.title }}">
                                        <input type="hidden" name="release_date" value="{{ movie_api.release_date }}">
                                        <input type="hidden" name="poster_path" value="{{ movie_api.poster_path }}">
                                        
                                        <button type="submit" class="btn btn-success btn-sm w-100">Añadir a mi Colección</button>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endblock content %}